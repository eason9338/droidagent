# DroidAgent ç³»çµ±æ¶æ§‹å®Œæ•´èªªæ˜

> é€™ä»½æ–‡æª”ç”¨ç™½è©±çš„æ–¹å¼è§£é‡‹ DroidAgent å¦‚ä½•è‡ªå‹•æ¸¬è©¦ Android APP

## ç›®éŒ„
1. [ç³»çµ±æ˜¯å¹¹å˜›çš„](#1-ç³»çµ±æ˜¯å¹¹å˜›çš„)
2. [ç³»çµ±æ€éº¼çŸ¥é“ APP æœ‰å“ªäº›é é¢](#2-ç³»çµ±æ€éº¼çŸ¥é“-app-æœ‰å“ªäº›é é¢)
3. [ç³»çµ±æ€éº¼å³æ™‚çœ‹åˆ°ç•«é¢ä¸Šæœ‰ä»€éº¼å…ƒä»¶](#3-ç³»çµ±æ€éº¼å³æ™‚çœ‹åˆ°ç•«é¢ä¸Šæœ‰ä»€éº¼å…ƒä»¶)
4. [å…ƒä»¶æ€éº¼è®Šæˆ Widgetï¼ˆé‡è¦ï¼ï¼‰](#4-å…ƒä»¶æ€éº¼è®Šæˆ-widgeté‡è¦)
5. [å››å€‹ LLM æ€éº¼å”åŒå·¥ä½œ](#5-å››å€‹-llm-æ€éº¼å”åŒå·¥ä½œ)
6. [ç‹€æ…‹æ©Ÿï¼šæ€éº¼æ±ºå®šä¸‹ä¸€å€‹ç”¨å“ªå€‹ Agent](#6-ç‹€æ…‹æ©Ÿæ€éº¼æ±ºå®šä¸‹ä¸€å€‹ç”¨å“ªå€‹-agent)
7. [è¨˜æ†¶ç³»çµ±æ€éº¼é‹ä½œ](#7-è¨˜æ†¶ç³»çµ±æ€éº¼é‹ä½œ)
8. [å®Œæ•´åŸ·è¡Œç¯„ä¾‹](#8-å®Œæ•´åŸ·è¡Œç¯„ä¾‹)

---

## 1. ç³»çµ±æ˜¯å¹¹å˜›çš„

### ç°¡å–®ä¾†èªª

DroidAgent æ˜¯ä¸€å€‹**ç”¨ AI è‡ªå‹•æ¸¬è©¦ Android APP çš„ç³»çµ±**ã€‚

å‚³çµ±æ¸¬è©¦å·¥å…·åªæœƒã€Œäº‚é»ã€ï¼Œä½† DroidAgent æœƒï¼š
- **çœ‹æ‡‚ç•«é¢**ï¼šçŸ¥é“é€™æ˜¯ã€Œç™»å…¥æŒ‰éˆ•ã€é‚„æ˜¯ã€Œè¨­å®šæŒ‰éˆ•ã€
- **è¨˜ä½ç¶“é©—**ï¼šè¨˜å¾—ã€Œé»é€™å€‹æŒ‰éˆ•æœƒè·³åˆ°å“ªå€‹é é¢ã€
- **è¦åŠƒä»»å‹™**ï¼šåƒçœŸäººä¸€æ¨£ã€Œæˆ‘è¦å»ºç«‹ä¸€å€‹æ–°è³‡æ–™å¤¾ã€
- **è‡ªæˆ‘æª¢è¨**ï¼šã€Œæˆ‘ä¸€ç›´åœ¨é»åŒä¸€å€‹æŒ‰éˆ•ï¼Œæ‡‰è©²æ›å€‹æ–¹å¼ã€

### æ ¸å¿ƒèƒ½åŠ›

| èƒ½åŠ› | èªªæ˜ |
|-----|------|
| **è‡ªå‹•æ¢ç´¢** | æ ¹æ“šã€Œç”¨æˆ¶è§’è‰²ã€ï¼ˆPersonaï¼‰æ™ºèƒ½åœ°æ¸¬è©¦ APP |
| **ä»»å‹™å°å‘** | ä¸æ˜¯äº‚é»ï¼Œè€Œæ˜¯è¦åŠƒæœ‰æ„ç¾©çš„ä»»å‹™ï¼ˆä¾‹å¦‚ã€Œå‰µå»ºæ–°æ–‡ä»¶ã€ï¼‰ |
| **çŸ¥è­˜ç´¯ç©** | è¨˜ä½æ¯å€‹æŒ‰éˆ•çš„åŠŸèƒ½ï¼Œä¸æœƒé‡è¤‡åšç„¡æ„ç¾©çš„æ“ä½œ |
| **è‡ªæˆ‘æ‰¹åˆ¤** | æ¯éš”å¹¾æ­¥å°±æª¢è¨ã€Œæˆ‘é€™æ¨£åšå°å—ã€ |

---

## 2. ç³»çµ±æ€éº¼çŸ¥é“ APP æœ‰å“ªäº›é é¢

### å•é¡Œ

ç³»çµ±è¦è¦åŠƒæ¸¬è©¦ä»»å‹™æ™‚ï¼Œéœ€è¦çŸ¥é“ã€Œé€™å€‹ APP ç¸½å…±æœ‰å“ªäº›é é¢ï¼Ÿã€æ‰èƒ½æ±ºå®šã€Œæˆ‘é‚„æœ‰å“ªäº›é é¢æ²’æ¸¬è©¦éã€ã€‚

### è§£æ±ºæ–¹æ³•ï¼šè§£æ APK æª”æ¡ˆ

æ¯å€‹ Android APP çš„ APK æª”æ¡ˆè£¡éƒ½æœ‰ä¸€å€‹ `AndroidManifest.xml`ï¼Œè£¡é¢è¨˜éŒ„äº†æ‰€æœ‰é é¢ï¼ˆActivityï¼‰ã€‚

**å¯¦éš›åšæ³•**ï¼š

**æª”æ¡ˆ**ï¼š`droidbot/droidbot/app.py`

```python
from androguard.core.apk import APK

# 1. ç”¨ Androguard åº«è§£æ APK
self.apk = APK(self.app_path)

# 2. å–å¾—æ‰€æœ‰é é¢åˆ—è¡¨
self.activities = self.apk.get_activities()
# ç¯„ä¾‹çµæœï¼š
# ['com.example.app/.MainActivity',
#  'com.example.app/.SettingsActivity',
#  'com.example.app/.ProfileActivity', ...]

# 3. æ‰¾å‡ºä¸»é é¢ï¼ˆAPP é–‹å•Ÿæ™‚ç¬¬ä¸€å€‹çœ‹åˆ°çš„é é¢ï¼‰
self.main_activity = self.apk.get_main_activities()[0]
# ç¯„ä¾‹çµæœï¼š'com.example.app/.MainActivity'
```

**Androguard æ€éº¼åšåˆ°çš„ï¼Ÿ**

APK å…¶å¯¦å°±æ˜¯å€‹ ZIP æª”ï¼ŒAndroguard æœƒï¼š
1. è§£å£“ç¸® APK
2. è®€å–è£¡é¢çš„ `AndroidManifest.xml`ï¼ˆæ˜¯äºŒé€²ä½æ ¼å¼ï¼‰
3. æŠŠäºŒé€²ä½ XML è½‰å›å¯è®€æ ¼å¼
4. ç”¨æ­£è¦è¡¨é”å¼æ‰¾å‡ºæ‰€æœ‰ `<activity>` æ¨™ç±¤

**ç¯„ä¾‹ AndroidManifest.xml**ï¼š
```xml
<manifest package="com.example.app">
    <application>
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        <activity android:name=".SettingsActivity"/>
        <activity android:name=".ProfileActivity"/>
    </application>
</manifest>
```

### å„²å­˜åˆ°é…ç½®

**æª”æ¡ˆ**ï¼š`droidagent/config.py:124-144`

```python
def set_app(self, app):
    # å–å¾— APP åç¨±
    self.app_name = app.apk.get_app_name()  # ä¾‹å¦‚ï¼š"Gmail"

    # å–å¾—å¥—ä»¶åç¨±
    self.package_name = app.get_package_name()  # ä¾‹å¦‚ï¼š"com.google.android.gm"

    # å–å¾—æ‰€æœ‰é é¢ï¼Œä¸¦éæ¿¾æ‰ç³»çµ±é é¢
    package_prefix = '.'.join(self.package_name.split('.')[:2])  # "com.google"

    app_activities = []
    for activity in app.activities:
        # æ’é™¤ç³»çµ±å’Œç¬¬ä¸‰æ–¹åº«çš„é é¢
        if package_prefix in activity and 'leakcanary' not in activity:
            # ç°¡åŒ–é é¢åç¨±ï¼ˆå»æ‰å¥—ä»¶å‰ç¶´ï¼‰
            activity_name = activity.split('/')[-1]  # "MainActivity"
            app_activities.append(activity_name)

    self.app_activities = app_activities
```

**æœ€å¾Œå¾—åˆ°çš„é é¢åˆ—è¡¨**ï¼š
```python
app_activities = [
    "MainActivity",
    "SettingsActivity",
    "ProfileActivity",
    "ComposeActivity",
    ...
]
```

### ç”¨é€”

é€™å€‹é é¢åˆ—è¡¨æœƒç”¨åœ¨ï¼š

1. **è¦åŠƒä»»å‹™æ™‚**ï¼šLLM æœƒçœ‹åˆ°ã€Œé‚„æœ‰å“ªäº›é é¢æ²’è¨ªå•éã€
2. **è¨ˆç®—è¦†è“‹ç‡**ï¼š`å·²è¨ªå•é é¢æ•¸ / ç¸½é é¢æ•¸`
3. **æ±ºå®šçµ‚æ­¢æ¢ä»¶**ï¼šã€Œæ‰€æœ‰é é¢éƒ½è¨ªå•éäº†ã€

---

## 3. ç³»çµ±æ€éº¼å³æ™‚çœ‹åˆ°ç•«é¢ä¸Šæœ‰ä»€éº¼å…ƒä»¶

### å•é¡Œ

ç³»çµ±éœ€è¦å³æ™‚çŸ¥é“ã€Œç¾åœ¨ç•«é¢ä¸Šæœ‰å“ªäº›æŒ‰éˆ•ã€è¼¸å…¥æ¡†ã€æ–‡å­—ã€ï¼Œæ‰èƒ½æ±ºå®šè¦é»ä»€éº¼ã€‚

ä½† Android ä¸å…è¨±å¤–éƒ¨ç¨‹å¼ç›´æ¥è®€å–å…¶ä»– APP çš„ UIï¼

### è§£æ±ºæ–¹æ³•ï¼šDroidBotApp + Accessibility Service

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

Android æœ‰å€‹åˆæ³•çš„ã€Œç„¡éšœç¤™æœå‹™ã€ï¼ˆAccessibility Serviceï¼‰ï¼Œæœ¬ä¾†æ˜¯çµ¦è¦–éšœäººå£«ç”¨çš„ï¼Œå¯ä»¥è®€å–æ•´å€‹ç•«é¢çš„å…ƒä»¶è³‡è¨Šã€‚

DroidAgent å°±æ˜¯åˆ©ç”¨é€™å€‹æœå‹™ï¼

### æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é›»è…¦             â”‚                    â”‚  Android æ‰‹æ©Ÿ    â”‚
â”‚  DroidAgent      â”‚                    â”‚                 â”‚
â”‚                  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                  â”‚  â‘ è¦æ±‚å–å¾—ç•«é¢è³‡è¨Š  â”‚  â”‚ DroidBotAppâ”‚  â”‚
â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚(è¼”åŠ© APP)  â”‚  â”‚
â”‚                  â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                    â”‚        â”‚        â”‚
â”‚                  â”‚                    â”‚        â‘¡è®€å–    â”‚
â”‚                  â”‚                    â”‚        â”‚        â”‚
â”‚                  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”‚
â”‚                  â”‚                    â”‚  â”‚Accessibilityâ”‚  â”‚
â”‚                  â”‚                    â”‚  â”‚  Service   â”‚  â”‚
â”‚                  â”‚                    â”‚  â”‚(ç³»çµ±æœå‹™)   â”‚  â”‚
â”‚                  â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                    â”‚        â”‚        â”‚
â”‚                  â”‚                    â”‚        â‘¢å–å¾—    â”‚
â”‚                  â”‚                    â”‚        â”‚        â”‚
â”‚                  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”‚
â”‚                  â”‚   â‘£å›å‚³ JSON è³‡æ–™  â”‚  â”‚View        â”‚  â”‚
â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚Hierarchy  â”‚  â”‚
â”‚                  â”‚                    â”‚  â”‚(UI æ¨¹ç‹€çµæ§‹)â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”˜
```

### è©³ç´°æµç¨‹

#### æ­¥é©Ÿ 1ï¼šå®‰è£ DroidBotApp

**æª”æ¡ˆ**ï¼š`droidbot/droidbot/adapter/droidbot_app.py:67-96`

```python
# ç³»çµ±å•Ÿå‹•æ™‚ï¼Œæœƒå…ˆæŠŠ DroidBotApp é€™å€‹è¼”åŠ© APP è£åˆ°æ‰‹æ©Ÿ
droidbot_app_path = "droidbot/resources/droidbotApp.apk"
device.adb.run_cmd(["install", droidbot_app_path])

# å•Ÿç”¨ Accessibility Service
ACCESSIBILITY_SERVICE = "io.github.ylimit.droidbotapp/.../PSAccessibilityService"
device.adb.enable_accessibility_service(ACCESSIBILITY_SERVICE)
```

#### æ­¥é©Ÿ 2ï¼šå»ºç«‹ Socket é€£ç·š

```python
# é€é ADB æŠŠé›»è…¦çš„æŸå€‹ port è½‰ç™¼åˆ°æ‰‹æ©Ÿçš„ 7336 port
forward_cmd = f"adb -s {device_serial} forward tcp:{port} tcp:7336"

# é›»è…¦é€£ç·šåˆ°æ‰‹æ©Ÿ
self.sock = socket.socket()
self.sock.connect(('localhost', port))
```

#### æ­¥é©Ÿ 3ï¼šæŒçºŒç›£è½ UI è®ŠåŒ–

**æª”æ¡ˆ**ï¼š`droidbot/droidbot/adapter/droidbot_app.py:135-172`

```python
def listen_messages(self):
    while self.connected:
        # è®€å–è¨Šæ¯é ­ï¼ˆ6 bytesï¼‰
        _, _, message_len = self.read_head()

        # è®€å–å®Œæ•´è¨Šæ¯
        message = self.sock_read(message_len)

        # è§£æè¨Šæ¯
        if "AccEvent >>>" in message:
            # DroidBotApp é€é Accessibility è®€å–åˆ°çš„ UI è³‡è¨Š
            body = json.loads(message.split("AccEvent >>> ")[1])
            self.last_acc_event = body  # å„²å­˜æœ€æ–°çš„ UI ç‹€æ…‹
```

#### æ­¥é©Ÿ 4ï¼šDroidBotApp å›å‚³çš„è³‡æ–™æ ¼å¼

```json
{
  "root_node": {
    "class": "android.widget.LinearLayout",
    "bounds": [0, 0, 1080, 1920],
    "resource_id": "com.example.app:id/root_layout",
    "text": null,
    "clickable": false,
    "scrollable": false,
    "editable": false,
    "long_clickable": false,
    "enabled": true,
    "visible": true,
    "checked": false,
    "focused": false,
    "children": [
      {
        "class": "android.widget.Button",
        "bounds": [100, 200, 300, 280],
        "resource_id": "com.example.app:id/submit_button",
        "text": "Submit",
        "clickable": true,
        "enabled": true,
        "children": []
      },
      {
        "class": "android.widget.EditText",
        "bounds": [100, 300, 500, 380],
        "resource_id": "com.example.app:id/username_input",
        "text": "",
        "editable": true,
        "children": []
      }
    ]
  }
}
```

### é—œéµæ¬„ä½èªªæ˜

æ¯å€‹å…ƒä»¶ï¼ˆViewï¼‰éƒ½æœ‰é€™äº›å±¬æ€§ï¼š

| å±¬æ€§ | èªªæ˜ | ç¯„ä¾‹ |
|-----|------|------|
| `class` | å…ƒä»¶é¡å‹ | `android.widget.Button` |
| `bounds` | è¢å¹•ä¸Šçš„ä½ç½® | `[100, 200, 300, 280]` (å·¦ä¸Š x,y åˆ°å³ä¸‹ x,y) |
| `resource_id` | é–‹ç™¼è€…å®šç¾©çš„ ID | `com.example.app:id/submit_button` |
| `text` | é¡¯ç¤ºçš„æ–‡å­— | `"Submit"` |
| `clickable` | èƒ½ä¸èƒ½é» | `true` / `false` |
| `editable` | èƒ½ä¸èƒ½è¼¸å…¥æ–‡å­— | `true` / `false` |
| `scrollable` | èƒ½ä¸èƒ½æ»‘å‹• | `true` / `false` |
| `long_clickable` | èƒ½ä¸èƒ½é•·æŒ‰ | `true` / `false` |
| `children` | å­å…ƒä»¶åˆ—è¡¨ | `[...]` |

---

## 4. å…ƒä»¶æ€éº¼è®Šæˆ Widgetï¼ˆé‡è¦ï¼ï¼‰

### ç‚ºä»€éº¼è¦è½‰æ›

å¾ DroidBotApp æ‹¿åˆ°çš„æ˜¯ã€ŒAndroid åŸç”Ÿçš„ View è³‡æ–™ã€ï¼Œä½† DroidAgent éœ€è¦çš„æ˜¯ã€Œæ›´é«˜éšçš„ Widget ç‰©ä»¶ã€ï¼ŒåŸå› ï¼š

1. **ç°¡åŒ–è³‡è¨Š**ï¼šåŸç”Ÿè³‡æ–™æœ‰å¾ˆå¤šä¸é‡è¦çš„æ¬„ä½
2. **åŠ ä¸Šæ™ºæ…§**ï¼šè‡ªå‹•åˆ¤æ–·ã€Œé€™å€‹å…ƒä»¶å¯ä»¥åšä»€éº¼æ“ä½œã€
3. **çµ±ä¸€æ ¼å¼**ï¼šè®“ LLM æ›´å®¹æ˜“ç†è§£

### è½‰æ›æµç¨‹åœ–

```
DroidBotApp å›å‚³çš„ JSON
        â”‚
        â–¼
DroidBot DeviceState (å¹³é¢åˆ—è¡¨ + æ¨¹ç‹€çµæ§‹)
        â”‚
        â–¼
DroidAgent GUIState (Widget ç‰©ä»¶åˆ—è¡¨)
        â”‚
        â”œâ”€â–º Widget 1: æŒ‰éˆ•
        â”œâ”€â–º Widget 2: è¼¸å…¥æ¡†
        â””â”€â–º Widget 3: æ–‡å­—æ¨™ç±¤
```

### æ­¥é©Ÿ 1ï¼šDroidBot æ•´ç†è³‡æ–™

**æª”æ¡ˆ**ï¼š`droidbot/droidbot/device_state.py:9-83`

```python
class DeviceState:
    def __init__(self, device, views, foreground_activity, ...):
        # å„²å­˜ç•¶å‰é é¢åç¨±
        self.foreground_activity = foreground_activity  # "MainActivity"

        # æŠŠå·¢ç‹€çš„æ¨¹ç‹€çµæ§‹ã€Œæ”¤å¹³ã€æˆåˆ—è¡¨
        self.views = []  # å¹³é¢åˆ—è¡¨ï¼Œæ–¹ä¾¿ç´¢å¼•
        self.view_tree = {}  # ä¿ç•™æ¨¹ç‹€çµæ§‹ï¼Œæ–¹ä¾¿ç†è§£å±¤æ¬¡

        # è½‰æ›ä¸¦è³¦äºˆæ¯å€‹ view ä¸€å€‹ temp_id
        self.__parse_views(views)
```

**ç‚ºä»€éº¼è¦è½‰æˆåˆ—è¡¨ï¼Ÿ**

åŸæœ¬çš„è³‡æ–™æ˜¯é€™æ¨£ï¼ˆå·¢ç‹€ï¼‰ï¼š
```
LinearLayout
  â”œâ”€ Button
  â””â”€ LinearLayout
      â”œâ”€ TextView
      â””â”€ EditText
```

è½‰æˆåˆ—è¡¨å¾Œï¼š
```python
views = [
    {id: 0, type: 'LinearLayout', children: [1, 2]},
    {id: 1, type: 'Button', parent: 0},
    {id: 2, type: 'LinearLayout', parent: 0, children: [3, 4]},
    {id: 3, type: 'TextView', parent: 2},
    {id: 4, type: 'EditText', parent: 2}
]
```

é€™æ¨£å°±å¯ä»¥ç”¨ `views[2]` å¿«é€Ÿæ‰¾åˆ°æŸå€‹å…ƒä»¶ï¼

### æ­¥é©Ÿ 2ï¼šDroidAgent å‰µå»º GUIState

**æª”æ¡ˆ**ï¼š`droidagent/types/gui_state.py:67-83`

```python
def from_droidbot_state(self, droidbot_state):
    self.activity = droidbot_state.foreground_activity  # "MainActivity"

    # ç°¡åŒ– view treeï¼ˆç§»é™¤ä¸å¿…è¦çš„å±¬æ€§ï¼‰
    view_tree = minimize_view_tree(droidbot_state.view_tree)

    # éè¿´éæ­·æ¯å€‹å…ƒä»¶ï¼Œè½‰æ›æˆ Widget ç‰©ä»¶
    self.widgets = []
    for root_elem in view_tree:
        widget = traverse_widgets(root_elem, self.widgets, droidbot_state.views)
        self.root_widgets.append(widget)
```

### æ­¥é©Ÿ 3ï¼šæœ€é—œéµï¼traverse_widgets å‡½æ•¸

é€™å€‹å‡½æ•¸æœƒï¼š
1. **åˆ¤æ–·å…ƒä»¶å¯ä»¥åšä»€éº¼æ“ä½œ**ï¼ˆé€™å°±æ˜¯ä½ å•çš„é‡é»ï¼ï¼‰
2. **æå–é‡è¦å±¬æ€§**
3. **å‰µå»º Widget ç‰©ä»¶**

**æª”æ¡ˆ**ï¼š`droidagent/types/gui_state.py:315-374`

```python
def traverse_widgets(elem, processed_widgets, original_views):
    new_elem = OrderedDict()
    possible_action_types = []  # é€™å€‹å…ƒä»¶å¯ä»¥åšä»€éº¼
    state_properties = []       # é€™å€‹å…ƒä»¶çš„ç‹€æ…‹

    # ==================== åˆ¤æ–·å¯åŸ·è¡Œçš„æ“ä½œ ====================
    # é€™è£¡å°±æ˜¯ç³»çµ±ã€ŒçŸ¥é“å¯ä»¥åšä»€éº¼æ“ä½œã€çš„é—œéµï¼

    # è¦å‰‡ 1ï¼šèƒ½é»æˆ–èƒ½å‹¾é¸ â†’ å¯ä»¥ touch
    if elem.get('clickable', False) or elem.get('checkable', False):
        possible_action_types.append('touch')

    # è¦å‰‡ 2ï¼šèƒ½é•·æŒ‰ â†’ å¯ä»¥ long_touch
    if elem.get('long_clickable', False):
        possible_action_types.append('long_touch')

    # è¦å‰‡ 3ï¼šèƒ½ç·¨è¼¯ â†’ å¯ä»¥è¼¸å…¥æ–‡å­—
    if elem.get('editable', False):
        possible_action_types.append('set_text')

    # è¦å‰‡ 4ï¼šèƒ½æ»‘å‹• â†’ å¯ä»¥ scroll
    if elem.get('scrollable', False):
        possible_action_types.append('scroll')

    # ==================== åˆ¤æ–·å…ƒä»¶çš„ç‹€æ…‹ ====================

    if elem.get('focused', False):
        state_properties.append('focused')  # æ­£åœ¨è¢«èšç„¦

    if elem.get('checked', False):
        state_properties.append('checked')  # å·²å‹¾é¸

    if elem.get('selected', False):
        state_properties.append('selected')  # å·²é¸å–

    # ==================== æå–é‡è¦å±¬æ€§ ====================

    # åªæœ‰å¯äº’å‹•çš„å…ƒä»¶æ‰çµ¦ IDï¼ˆçœè¨˜æ†¶é«”ï¼‰
    if len(possible_action_types) > 0 and 'temp_id' in elem:
        new_elem['ID'] = elem['temp_id']

    # å…ƒä»¶é¡å‹ï¼ˆç°¡åŒ–ï¼Œåªå–é¡åæœ€å¾Œä¸€æ®µï¼‰
    if 'class' in elem:
        # "android.widget.Button" â†’ "Button"
        new_elem['widget_type'] = elem['class'].split('.')[-1]

    # é¡¯ç¤ºæ–‡å­—
    if 'text' in elem and elem['text']:
        new_elem['text'] = elem['text'][:100]  # æœ€å¤š 100 å­—

    # å…§å®¹æè¿°ï¼ˆçµ¦è¦–éšœäººå£«è½çš„ï¼‰
    if 'content_description' in elem:
        new_elem['content_description'] = elem['content_description']

    # Resource IDï¼ˆç°¡åŒ–ï¼‰
    if 'resource_id' in elem and elem['resource_id']:
        # "com.example.app:id/submit_button" â†’ "submit_button"
        new_elem['resource_id'] = elem['resource_id'].split('/')[-1]

    # æ˜¯å¦ç‚ºå¯†ç¢¼æ¬„ä½
    if elem.get('is_password'):
        new_elem['is_password'] = True

    # å„²å­˜åˆ¤æ–·çµæœ
    if len(state_properties) > 0:
        new_elem['state'] = state_properties

    if len(possible_action_types) > 0:
        new_elem['possible_action_types'] = possible_action_types

    # å…ƒä»¶ä½ç½®
    new_elem['bounds'] = elem['bounds']

    # ==================== éè¿´è™•ç†å­å…ƒä»¶ ====================

    children_widgets = []
    for child in elem.get('children', []):
        child_widget = traverse_widgets(child, processed_widgets, original_views)
        children_widgets.append(child_widget)

    new_elem['children'] = children_widgets

    # ==================== å‰µå»º Widget ç‰©ä»¶ ====================

    widget = Widget().from_dict(new_elem)
    processed_widgets.append(widget)

    return widget
```

### è½‰æ›ç¯„ä¾‹

**è¼¸å…¥ï¼ˆAndroid åŸç”Ÿæ ¼å¼ï¼‰**ï¼š
```json
{
  "class": "android.widget.Button",
  "bounds": [100, 200, 300, 280],
  "resource_id": "com.example.app:id/submit_button",
  "text": "Submit",
  "clickable": true,
  "long_clickable": false,
  "editable": false,
  "scrollable": false,
  "enabled": true,
  "children": []
}
```

**è¼¸å‡ºï¼ˆWidget ç‰©ä»¶ï¼‰**ï¼š
```json
{
  "ID": 15,
  "widget_type": "Button",
  "resource_id": "submit_button",
  "text": "Submit",
  "possible_action_types": ["touch"],
  "bounds": [[100, 200], [300, 280]],
  "children": []
}
```

### é‡é»æ•´ç†

**ç³»çµ±æ€éº¼çŸ¥é“ Widget å¯ä»¥åšä»€éº¼æ“ä½œï¼Ÿ**

ç­”æ¡ˆï¼š**çœ‹ Accessibility Service å›å‚³çš„å±¬æ€§ï¼**

```python
if clickable == true:
    â†’ å¯ä»¥ touch

if long_clickable == true:
    â†’ å¯ä»¥ long_touch

if editable == true:
    â†’ å¯ä»¥ set_text (è¼¸å…¥æ–‡å­—)

if scrollable == true:
    â†’ å¯ä»¥ scroll (æ»‘å‹•)
```

é€™äº›å±¬æ€§æ˜¯ **Android ç³»çµ±è‡ªå·±æ¨™è¨˜çš„**ï¼Œé–‹ç™¼è€…åœ¨å¯« APP æ™‚å°±æœƒè¨­å®šï¼

---

## 5. å››å€‹ LLM æ€éº¼å”åŒå·¥ä½œ

### æ¦‚å¿µ

DroidAgent ä¸æ˜¯ç”¨ä¸€å€‹ LLM åšæ‰€æœ‰äº‹ï¼Œè€Œæ˜¯æŠŠå·¥ä½œæ‹†æˆå››å€‹è§’è‰²ï¼š

| è§’è‰² | è² è²¬çš„äº‹ | ç”¨çš„ LLM |
|-----|---------|---------|
| **Planner** | è¦åŠƒæ–°ä»»å‹™ | GPT-4o-mini |
| **Observer** | è§€å¯Ÿç•«é¢è®ŠåŒ– | GPT-4o-mini |
| **Actor** | é¸æ“‡ä¸‹ä¸€æ­¥å‹•ä½œ | GPT-4o-mini |
| **Reflector** | è©•ä¼°ä»»å‹™çµæœ | GPT-4o-mini |

### ç‚ºä»€éº¼è¦é€™æ¨£è¨­è¨ˆï¼Ÿ

1. **åˆ†å·¥æ˜ç¢º**ï¼šæ¯å€‹ LLM åªå°ˆæ³¨åšä¸€ä»¶äº‹ï¼Œæ•ˆæœæ›´å¥½
2. **å¯ä»¥èª¿æ•´**ï¼šä¾‹å¦‚å¯ä»¥è®“ Planner ç”¨æ›´è°æ˜çš„æ¨¡å‹
3. **æ–¹ä¾¿ç ”ç©¶**ï¼šå¯ä»¥åšæ¶ˆèå¯¦é©—ï¼ˆAblation Studyï¼‰çœ‹å“ªå€‹çµ„ä»¶æœ€é‡è¦

### å¾ªç’°ç¤ºæ„åœ–

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Planner    â”‚  è¦åŠƒæ–°ä»»å‹™ï¼šã€Œå‰µå»ºä¸€å€‹æ–°è³‡æ–™å¤¾ã€
    â”‚             â”‚  é¸æ“‡ç¬¬ä¸€æ­¥å‹•ä½œï¼šã€Œé»æ“Šæ–°å¢æŒ‰éˆ•ã€
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Observer   â”‚  è§€å¯Ÿè®ŠåŒ–ï¼šã€Œå‡ºç¾äº†ä¸€å€‹å°è©±æ¡†ï¼Œæœ‰è¼¸å…¥æ¡†å’Œç¢ºèªæŒ‰éˆ•ã€
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Actor      â”‚  é¸æ“‡å‹•ä½œï¼šã€Œåœ¨è¼¸å…¥æ¡†è¼¸å…¥ 'My Folder'ã€
    â”‚             â”‚  ï¼ˆæ¯ 4 æ­¥æœƒè‡ªæˆ‘æ‰¹åˆ¤ä¸€æ¬¡ï¼‰
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Observer   â”‚  è§€å¯Ÿè®ŠåŒ–ï¼šã€Œè¼¸å…¥æ¡†é¡¯ç¤ºäº†æ–‡å­—ã€
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Actor      â”‚  é¸æ“‡å‹•ä½œï¼šã€Œé»æ“Šç¢ºèªæŒ‰éˆ•ã€
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Observer   â”‚  è§€å¯Ÿè®ŠåŒ–ï¼šã€Œå°è©±æ¡†æ¶ˆå¤±ï¼Œå‡ºç¾äº†æ–°è³‡æ–™å¤¾ã€
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Actor      â”‚  é¸æ“‡å‹•ä½œï¼šã€ŒçµæŸä»»å‹™ã€
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Reflector  â”‚  è©•ä¼°çµæœï¼šã€ŒæˆåŠŸï¼å­¸åˆ°ï¼šè¦å‰µå»ºè³‡æ–™å¤¾ï¼Œ
    â”‚             â”‚  éœ€è¦é»æ–°å¢â†’è¼¸å…¥åç¨±â†’ç¢ºèªã€
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â–º å›åˆ° Plannerï¼ˆè¦åŠƒä¸‹ä¸€å€‹ä»»å‹™ï¼‰
```

---

## 6. ç‹€æ…‹æ©Ÿï¼šæ€éº¼æ±ºå®šä¸‹ä¸€å€‹ç”¨å“ªå€‹ Agent

### æ ¸å¿ƒæ¦‚å¿µ

ç³»çµ±ç”¨**ç‹€æ…‹æ©Ÿ**ï¼ˆState Machineï¼‰ä¾†æ§åˆ¶æµç¨‹ï¼Œæœ‰ 4 å€‹ç‹€æ…‹ï¼ˆModeï¼‰ï¼š

```
MODE_PLAN    â†’ è¦åŠƒæ¨¡å¼ï¼ˆç”¨ Plannerï¼‰
MODE_OBSERVE â†’ è§€å¯Ÿæ¨¡å¼ï¼ˆç”¨ Observerï¼‰
MODE_ACT     â†’ è¡Œå‹•æ¨¡å¼ï¼ˆç”¨ Actorï¼‰
MODE_REFLECT â†’ åæ€æ¨¡å¼ï¼ˆç”¨ Reflectorï¼‰
```

### ç‹€æ…‹è½‰æ›è¦å‰‡

**æª”æ¡ˆ**ï¼š`droidagent/agent.py:126-201`

è®“æˆ‘ç”¨æ›´ç™½è©±çš„æ–¹å¼è§£é‡‹ï¼š

```python
class TaskBasedAgent:
    def __init__(self, ...):
        # åˆå§‹åŒ–æ™‚ï¼Œå¾ã€Œè¦åŠƒæ¨¡å¼ã€é–‹å§‹
        self.mode = MODE_PLAN
        self.step_count = 0

    def step(self):
        """æ¯æ¬¡ä¸»ç¨‹å¼å‘¼å« step()ï¼ŒAgent æœƒæ ¹æ“šç•¶å‰æ¨¡å¼åšä¸åŒçš„äº‹"""

        self.step_count += 1
        print(f"ç¬¬ {self.step_count} æ­¥ï¼Œç•¶å‰æ¨¡å¼ï¼š{self.mode}")

        # ==================== æ¨¡å¼ 1ï¼šè¦åŠƒæ–°ä»»å‹™ ====================
        if self.mode == MODE_PLAN:
            print("ğŸ‘‰ ç”¨ Planner è¦åŠƒæ–°ä»»å‹™...")

            # é‡ç½® Actor çš„è¨ˆæ•¸å™¨
            self.actor.reset()

            # Planner è¦åŠƒä»»å‹™ä¸¦é¸æ“‡ç¬¬ä¸€æ­¥å‹•ä½œ
            first_action = self.planner.plan_task()

            if first_action is not None:
                # æœ‰ä»»å‹™ â†’ åˆ‡æ›åˆ°ã€Œè§€å¯Ÿæ¨¡å¼ã€
                self.mode = MODE_OBSERVE
                return first_action  # å›å‚³å‹•ä½œçµ¦ä¸»ç¨‹å¼åŸ·è¡Œ
            else:
                # æ²’ä»»å‹™ï¼ˆå¯èƒ½ LLM å¤±æ•—äº†ï¼‰â†’ ä¸åšäº‹
                return None

        # ==================== æ¨¡å¼ 2ï¼šè§€å¯Ÿç•«é¢è®ŠåŒ– ====================
        elif self.mode == MODE_OBSERVE:
            print("ğŸ‘‰ ç”¨ Observer è§€å¯Ÿè®ŠåŒ–...")

            # Observer æ¯”è¼ƒå‰å¾Œç•«é¢ï¼Œç¸½çµè®ŠåŒ–
            observation = self.observer.observe_action_result()

            if observation:
                print(f"è§€å¯Ÿåˆ°ï¼š{observation}")
                # è¨˜éŒ„åˆ°è¨˜æ†¶ç³»çµ±
                self.memory.working_memory.add_step(observation, 'OBSERVATION')
                self.memory.widget_knowledge.add_observation(...)  # ç´¯ç©çŸ¥è­˜

            # åˆ‡æ›åˆ°ã€Œè¡Œå‹•æ¨¡å¼ã€
            self.mode = MODE_ACT
            return None  # ä¸åŸ·è¡Œå‹•ä½œï¼Œåªæ˜¯è§€å¯Ÿ

        # ==================== æ¨¡å¼ 3ï¼šé¸æ“‡ä¸‹ä¸€æ­¥å‹•ä½œ ====================
        elif self.mode == MODE_ACT:
            print("ğŸ‘‰ ç”¨ Actor é¸æ“‡å‹•ä½œ...")

            # æª¢æŸ¥ï¼šå¦‚æœå·²ç¶“åŸ·è¡Œå¤ªå¤šæ­¥ï¼ˆ13 æ­¥ï¼‰ï¼Œå¼·åˆ¶çµæŸä»»å‹™
            if self.actor.action_count >= 13:
                print("âš ï¸ ä»»å‹™å¤ªé•·äº†ï¼Œå¼·åˆ¶çµæŸ")
                self.mode = MODE_REFLECT
                return None

            # Actor é¸æ“‡ä¸‹ä¸€æ­¥å‹•ä½œ
            next_action = self.actor.act()

            if next_action is None:
                # Actor é¸æ“‡ã€ŒçµæŸä»»å‹™ã€â†’ åˆ‡æ›åˆ°ã€Œåæ€æ¨¡å¼ã€
                self.mode = MODE_REFLECT
                return None
            else:
                # æœ‰å‹•ä½œ â†’ åˆ‡æ›åˆ°ã€Œè§€å¯Ÿæ¨¡å¼ã€ï¼ˆåŸ·è¡Œå®Œå¾Œè¦çœ‹çµæœï¼‰
                self.mode = MODE_OBSERVE
                return next_action

        # ==================== æ¨¡å¼ 4ï¼šè©•ä¼°ä»»å‹™çµæœ ====================
        elif self.mode == MODE_REFLECT:
            print("ğŸ‘‰ ç”¨ Reflector è©•ä¼°ä»»å‹™...")

            # Reflector è©•ä¼°ä»»å‹™æˆåŠŸ/å¤±æ•—ï¼Œä¸¦æå–å­¸ç¿’
            task_result = self.reflector.reflect()
            print(f"ä»»å‹™çµæœï¼š{task_result}")

            # åˆ‡æ›å›ã€Œè¦åŠƒæ¨¡å¼ã€ï¼ˆæº–å‚™è¦åŠƒä¸‹ä¸€å€‹ä»»å‹™ï¼‰
            self.mode = MODE_PLAN
            return None
```

### ä¸»ç¨‹å¼çš„ç„¡é™è¿´åœˆ

**æª”æ¡ˆ**ï¼š`scripts/run_droidagent.py:59-107`

```python
def main(device, app, persona):
    # åˆå§‹åŒ– Agent
    agent = TaskBasedAgent(output_dir, app=app, persona=persona)
    device_manager = DeviceManager(device, app, output_dir)

    # ç„¡é™è¿´åœˆï¼ˆç›´åˆ°é”åˆ°æœ€å¤§æ­¥æ•¸æˆ– 2 å°æ™‚ï¼‰
    while True:
        if agent.step_count > 8000:
            print("é”åˆ°æœ€å¤§æ­¥æ•¸ï¼ŒçµæŸæ¸¬è©¦")
            break

        # æª¢æŸ¥ç•«é¢æ˜¯å¦åœ¨è¼‰å…¥ä¸­
        if is_loading_state(device_manager.current_state):
            print("ç•«é¢è¼‰å…¥ä¸­ï¼Œç­‰å¾…...")
            time.sleep(1)
            continue

        # ========== é—œéµï¼šå‘¼å« Agent çš„ step() ==========
        action = agent.step()

        # å„²å­˜è¨˜æ†¶å¿«ç…§ï¼ˆé™¤éŒ¯ç”¨ï¼‰
        agent.save_memory_snapshot()

        # å¦‚æœ Agent å›å‚³äº†å‹•ä½œï¼Œå°±åŸ·è¡Œåˆ°æ‰‹æ©Ÿ
        if action is not None:
            print(f"åŸ·è¡Œå‹•ä½œï¼š{action}")

            # æŠŠå‹•ä½œè½‰æˆ DroidBot äº‹ä»¶
            events = action.to_droidbot_event()

            # é€é ADB ç™¼é€åˆ°æ‰‹æ©Ÿ
            for event in events:
                device_manager.send_event_to_device(event)

            # æ›´æ–° Agent çš„ GUI ç‹€æ…‹
            agent.set_current_gui_state(device_manager.current_state)
```

### ç‹€æ…‹è½‰æ›æµç¨‹åœ–

```
é–‹å§‹
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MODE_PLAN   â”‚ Planner è¦åŠƒä»»å‹™
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å›å‚³ç¬¬ä¸€æ­¥å‹•ä½œ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ä¸»ç¨‹å¼åŸ·è¡Œå‹•ä½œ â”‚ ä¾‹å¦‚ï¼šé»æ“ŠæŒ‰éˆ•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MODE_OBSERVE â”‚ Observer è§€å¯Ÿè®ŠåŒ–
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ è¨˜éŒ„è§€å¯Ÿçµæœ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MODE_ACT    â”‚ Actor é¸æ“‡ä¸‹ä¸€æ­¥
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ é¸æ“‡å‹•ä½œ â”€â”€â”€â”€â”€â”€â–º ä¸»ç¨‹å¼åŸ·è¡Œ â”€â”€â–º å›åˆ° MODE_OBSERVE
       â”‚
       â””â”€ é¸æ“‡çµæŸä»»å‹™ â”€â”€â–º MODE_REFLECT
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚MODE_REFLECT â”‚ Reflector è©•ä¼°çµæœ
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º å›åˆ° MODE_PLANï¼ˆè¦åŠƒä¸‹ä¸€å€‹ä»»å‹™ï¼‰
```

### å¯¦éš›åŸ·è¡Œç¯„ä¾‹

```
Step 1, Mode: MODE_PLAN
ğŸ‘‰ Planner: è¦åŠƒä»»å‹™ã€Œå‰µå»ºæ–°è³‡æ–™å¤¾ã€
ğŸ‘‰ Planner: ç¬¬ä¸€æ­¥å‹•ä½œã€Œé»æ“Šæ–°å¢æŒ‰éˆ• (ID: 10)ã€
[ä¸»ç¨‹å¼åŸ·è¡Œå‹•ä½œ]

Step 2, Mode: MODE_OBSERVE
ğŸ‘‰ Observer: è§€å¯Ÿåˆ°ã€Œå‡ºç¾äº†å°è©±æ¡†ï¼Œæœ‰è¼¸å…¥æ¡†å’Œç¢ºèªæŒ‰éˆ•ã€

Step 3, Mode: MODE_ACT
ğŸ‘‰ Actor: é¸æ“‡å‹•ä½œã€Œåœ¨è¼¸å…¥æ¡†è¼¸å…¥ 'My Folder' (ID: 15)ã€
[ä¸»ç¨‹å¼åŸ·è¡Œå‹•ä½œ]

Step 4, Mode: MODE_OBSERVE
ğŸ‘‰ Observer: è§€å¯Ÿåˆ°ã€Œè¼¸å…¥æ¡†é¡¯ç¤ºäº†æ–‡å­—ã€

Step 5, Mode: MODE_ACT
ğŸ‘‰ Actor: é¸æ“‡å‹•ä½œã€Œé»æ“Šç¢ºèªæŒ‰éˆ• (ID: 16)ã€
[ä¸»ç¨‹å¼åŸ·è¡Œå‹•ä½œ]

Step 6, Mode: MODE_OBSERVE
ğŸ‘‰ Observer: è§€å¯Ÿåˆ°ã€Œå°è©±æ¡†æ¶ˆå¤±ï¼Œå‡ºç¾æ–°è³‡æ–™å¤¾ã€

Step 7, Mode: MODE_ACT
ğŸ‘‰ Actor: é¸æ“‡ã€ŒçµæŸä»»å‹™ã€

Step 8, Mode: MODE_REFLECT
ğŸ‘‰ Reflector: ä»»å‹™æˆåŠŸï¼å­¸åˆ°ã€Œå‰µå»ºè³‡æ–™å¤¾éœ€è¦ï¼šé»æ–°å¢â†’è¼¸å…¥åç¨±â†’ç¢ºèªã€

Step 9, Mode: MODE_PLAN
ğŸ‘‰ Planner: è¦åŠƒæ–°ä»»å‹™ã€Œé–‹å•Ÿå‰›å‰µå»ºçš„è³‡æ–™å¤¾ã€
...
```

### ç‚ºä»€éº¼è¦ç”¨ç‹€æ…‹æ©Ÿï¼Ÿ

1. **æ¸…æ¥šçš„æ§åˆ¶æµç¨‹**ï¼šä¸æœƒäº‚æ‰ï¼Œæ°¸é çŸ¥é“ä¸‹ä¸€æ­¥è©²åšä»€éº¼
2. **å®¹æ˜“é™¤éŒ¯**ï¼šçœ‹ log å°±çŸ¥é“å¡åœ¨å“ªå€‹æ¨¡å¼
3. **å¯ä»¥æš«åœ/æ¢å¾©**ï¼šå„²å­˜ `self.mode` å°±èƒ½æ¢å¾©ç‹€æ…‹

---

## 7. è¨˜æ†¶ç³»çµ±æ€éº¼é‹ä½œ

### å››ç¨®è¨˜æ†¶

| è¨˜æ†¶é¡å‹ | å­˜åœ¨å“ªè£¡ | å­˜ä»€éº¼ | ç”¨é€” |
|---------|---------|-------|------|
| **WorkingMemory** | å…§å­˜ï¼ˆRAMï¼‰ | ç•¶å‰ä»»å‹™çš„åŸ·è¡Œæ­¥é©Ÿ | çµ¦ LLM çœ‹ã€Œæˆ‘åšäº†ä»€éº¼ã€ |
| **TaskMemory** | ChromaDB å‘é‡è³‡æ–™åº« | éå»ä»»å‹™çš„æ­·å²è¨˜éŒ„ | é¿å…é‡è¤‡åšç›¸åŒä»»å‹™ |
| **SpatialMemory** | ChromaDB å‘é‡è³‡æ–™åº« | Widget çš„è¡Œç‚ºçŸ¥è­˜ | è¨˜ä½ã€Œé»é€™å€‹æŒ‰éˆ•æœƒæ€æ¨£ã€ |
| **PersistentStorage** | ChromaDB å‘é‡è³‡æ–™åº« | åº•å±¤å„²å­˜ | æä¾›èªç¾©æœå°‹åŠŸèƒ½ |

### WorkingMemoryï¼šçŸ­æœŸè¨˜æ†¶

**å°±åƒäººçš„ã€Œå·¥ä½œè¨˜æ†¶ã€**ï¼Œåªè¨˜ä½ç•¶å‰ä»»å‹™çš„äº‹ã€‚

**æª”æ¡ˆ**ï¼š`droidagent/memories/working_memory.py`

```python
class WorkingMemory:
    def __init__(self, task):
        self.task = task  # ç•¶å‰ä»»å‹™
        self.steps = []   # åŸ·è¡Œæ­¥é©Ÿåˆ—è¡¨

    def add_step(self, description, activity, step_type):
        """è¨˜éŒ„ä¸€å€‹æ­¥é©Ÿ"""
        timestamp = time.strftime('%Y-%m-%d %H:%M:%S')
        self.steps.append((description, activity, step_type, timestamp))
```

**å…§å®¹ç¯„ä¾‹**ï¼š
```python
{
  "task": "å‰µå»ºæ–°è³‡æ–™å¤¾",
  "steps": [
    ("é»æ“Šæ–°å¢æŒ‰éˆ• (ID: 10)", "MainActivity", "ACTION", "2025-01-15 10:23:45"),
    ("å‡ºç¾å°è©±æ¡†ï¼Œæœ‰è¼¸å…¥æ¡†", "MainActivity", "OBSERVATION", "2025-01-15 10:23:46"),
    ("è¼¸å…¥æ–‡å­— 'My Folder' åˆ°è¼¸å…¥æ¡† (ID: 15)", "MainActivity", "ACTION", "2025-01-15 10:23:47"),
    ("è¼¸å…¥æ¡†é¡¯ç¤ºæ–‡å­—", "MainActivity", "OBSERVATION", "2025-01-15 10:23:48"),
    ("é»æ“Šç¢ºèªæŒ‰éˆ• (ID: 16)", "MainActivity", "ACTION", "2025-01-15 10:23:49"),
    ("å°è©±æ¡†æ¶ˆå¤±ï¼Œæ–°è³‡æ–™å¤¾å‡ºç¾", "MainActivity", "OBSERVATION", "2025-01-15 10:23:50")
  ]
}
```

**Step é¡å‹**ï¼š
- `ACTION`ï¼šåŸ·è¡Œçš„å‹•ä½œ
- `OBSERVATION`ï¼šè§€å¯Ÿåˆ°çš„è®ŠåŒ–
- `CRITIQUE`ï¼šè‡ªæˆ‘æ‰¹åˆ¤

### SpatialMemoryï¼šWidget çŸ¥è­˜åº«

**è¨˜ä½æ¯å€‹æŒ‰éˆ•ã€è¼¸å…¥æ¡†çš„åŠŸèƒ½**ï¼Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°æ¢ç´¢ã€‚

**æª”æ¡ˆ**ï¼š`droidagent/memories/spatial_memory.py`

**è¨˜éŒ„æ™‚æ©Ÿ**ï¼šæ¯æ¬¡ Observer è§€å¯Ÿåˆ°è®ŠåŒ–å¾Œ

```python
def add_widget_wise_observation(self, page, widget_signature, observation, action):
    """
    è¨˜éŒ„ï¼šåœ¨æŸå€‹é é¢ä¸Šï¼Œå°æŸå€‹ Widget åŸ·è¡ŒæŸå€‹å‹•ä½œå¾Œï¼Œè§€å¯Ÿåˆ°ä»€éº¼
    """

    # å„²å­˜åˆ° ChromaDB
    self.storage.add_entry(
        document=f"{page} page: {widget.stringify()}",  # ç”¨æ–¼èªç¾©æœå°‹
        metadata={
            'type': 'WIDGET',
            'page': page,                    # ä¾‹å¦‚ï¼š"MainActivity"
            'widget': widget_signature,      # ä¾‹å¦‚ï¼š"Button-add_button-Add"
            'action': action.type,           # ä¾‹å¦‚ï¼š"touch"
            'observation': observation,      # ä¾‹å¦‚ï¼š"å‡ºç¾å°è©±æ¡†"
            'task': task.summary
        }
    )
```

**å„²å­˜ç¯„ä¾‹**ï¼š
```json
{
  "document": "MainActivity page: a button with resource_id 'add_button'",
  "metadata": {
    "type": "WIDGET",
    "page": "MainActivity",
    "widget": "Button-add_button-Add",
    "action": "touch",
    "observation": "A dialog appeared for creating a new folder",
    "task": "å‰µå»ºæ–°è³‡æ–™å¤¾"
  }
}
```

**æª¢ç´¢æ™‚æ©Ÿ**ï¼šActor è¦åŠƒå‹•ä½œæ™‚

```python
def retrieve_widget_knowledge(self, state, widget, N=5):
    """
    æª¢ç´¢ï¼šé€™å€‹ Widget éå»è¢«æ“ä½œéå¹¾æ¬¡ï¼Ÿæ¯æ¬¡çš„çµæœæ˜¯ä»€éº¼ï¼Ÿ
    """

    # ç”¨ç•¶å‰ç•«é¢ç‹€æ…‹ä½œç‚ºæŸ¥è©¢ï¼ˆèªç¾©æœå°‹ï¼‰
    results = self.storage.query(
        query_texts=[state.signature],  # ä¾‹å¦‚ï¼š"MainActivity page: button..."
        n_results=N,
        where={
            'type': 'WIDGET',
            'page': state.activity,
            'widget': widget.signature
        }
    )

    # å–å¾—éå»çš„è§€å¯Ÿè¨˜éŒ„
    observations = []
    for metadata in results['metadatas']:
        observations.append(f"- {metadata['action']}: {metadata['observation']}")

    # ç”¨ LLM ç¸½çµ
    summary = llm_summarize(widget, observations)

    return summary
```

**æª¢ç´¢ç¯„ä¾‹**ï¼š

ç•¶ Actor çœ‹åˆ°ã€Œæ–°å¢æŒ‰éˆ•ã€æ™‚ï¼š

```
æŸ¥è©¢: "MainActivity page: button with resource_id 'add_button'"

æª¢ç´¢çµæœï¼ˆå‰ 5 ç­†ï¼‰:
1. touch â†’ A dialog appeared for creating a new folder
2. touch â†’ A dialog with input field appeared
3. touch â†’ Opens the folder creation interface

LLM ç¸½çµ:
"This button opens a dialog for creating a new folder"
```

é€™å€‹ç¸½çµæœƒè¢«åŠ åˆ° Widget çš„æè¿°ä¸­ï¼š

```json
{
  "ID": 10,
  "widget_type": "Button",
  "resource_id": "add_button",
  "text": "Add",
  "possible_action_types": ["touch"],
  "num_prev_actions": 3,  â† è¨˜æ†¶ï¼
  "widget_role_inference": "Opens a dialog for creating a new folder"  â† è¨˜æ†¶ï¼
}
```

### ChromaDBï¼šå‘é‡è³‡æ–™åº«

**ç‚ºä»€éº¼ç”¨å‘é‡è³‡æ–™åº«è€Œä¸æ˜¯æ™®é€šè³‡æ–™åº«ï¼Ÿ**

å› ç‚ºéœ€è¦**èªç¾©æœå°‹**ï¼

**å‚³çµ±è³‡æ–™åº«**ï¼š
```sql
SELECT * FROM memories WHERE widget = 'add_button'
```
åªèƒ½æ‰¾åˆ°å®Œå…¨ä¸€æ¨£çš„é—œéµå­—ã€‚

**ChromaDB**ï¼š
```python
query_texts=["å¦‚ä½•å‰µå»ºæ–°è³‡æ–™å¤¾"]
```
æœƒæ‰¾åˆ°èªç¾©ç›¸ä¼¼çš„æ–‡æª”ï¼Œå³ä½¿æ²’æœ‰ã€Œè³‡æ–™å¤¾ã€é€™å€‹è©ï¼

**åŸç†**ï¼š

1. **æ–‡å­— â†’ å‘é‡ï¼ˆEmbeddingï¼‰**
   ```
   "å‰µå»ºæ–°è³‡æ–™å¤¾" â†’ [0.12, 0.45, 0.78, -0.33, ...]  (1536 ç¶­å‘é‡)
   "æ–°å¢æª”æ¡ˆå¤¾"   â†’ [0.15, 0.43, 0.76, -0.35, ...]  (å¾ˆæ¥è¿‘ï¼)
   "åˆªé™¤æ–‡ä»¶"     â†’ [-0.82, 0.23, -0.11, 0.67, ...] (å¾ˆé )
   ```

2. **è¨ˆç®—ç›¸ä¼¼åº¦ï¼ˆé¤˜å¼¦ç›¸ä¼¼åº¦ï¼‰**
   ```
   similarity("å‰µå»ºæ–°è³‡æ–™å¤¾", "æ–°å¢æª”æ¡ˆå¤¾") = 0.95  (å¾ˆåƒï¼)
   similarity("å‰µå»ºæ–°è³‡æ–™å¤¾", "åˆªé™¤æ–‡ä»¶")   = 0.12  (ä¸åƒ)
   ```

3. **è¿”å›æœ€ç›¸ä¼¼çš„æ–‡æª”**

---

## 8. å®Œæ•´åŸ·è¡Œç¯„ä¾‹

è®“æˆ‘ç”¨ä¸€å€‹å®Œæ•´çš„ä¾‹å­ï¼Œä¸²èµ·æ‰€æœ‰æ¦‚å¿µã€‚

### å ´æ™¯ï¼šæ¸¬è©¦ä¸€å€‹ç­†è¨˜ APP

**APP è³‡è¨Š**ï¼š
- å¥—ä»¶åç¨±ï¼š`com.example.notes`
- é é¢åˆ—è¡¨ï¼š`["MainActivity", "EditorActivity", "SettingsActivity"]`
- Personaï¼šåå« Jade çš„ä½¿ç”¨è€…ï¼Œç›®æ¨™æ˜¯ã€Œç›¡å¯èƒ½æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½ã€

### åŸ·è¡Œæµç¨‹

#### å•Ÿå‹•éšæ®µ

```bash
$ python run_droidagent.py --app Notes --profile_id jade
```

```
1. è§£æ APK
   âœ“ å¥—ä»¶åç¨±ï¼šcom.example.notes
   âœ“ ä¸»é é¢ï¼šMainActivity
   âœ“ æ‰€æœ‰é é¢ï¼š["MainActivity", "EditorActivity", "SettingsActivity"]

2. é€£æ¥è¨­å‚™
   âœ“ è¨­å‚™ï¼šemulator-5554
   âœ“ å®‰è£ DroidBotApp
   âœ“ å•Ÿç”¨ Accessibility Service

3. å®‰è£ä¸¦å•Ÿå‹• APP
   âœ“ å®‰è£ Notes.apk
   âœ“ å•Ÿå‹• APP (MainActivity)

4. åˆå§‹åŒ– Agent
   âœ“ å‰µå»º Planner, Observer, Actor, Reflector
   âœ“ åˆå§‹åŒ– ChromaDB è¨˜æ†¶ç³»çµ±
   âœ“ æ¨¡å¼ï¼šMODE_PLAN
```

#### Step 1-3ï¼šç¬¬ä¸€å€‹ä»»å‹™

```
========== Step 1 ==========
Mode: MODE_PLAN

Planner çœ‹åˆ°çš„è³‡è¨Šï¼š
- æ‰€æœ‰é é¢ï¼š["MainActivity", "EditorActivity", "SettingsActivity"]
- å·²è¨ªå•ï¼š{"MainActivity": 1}
- æœªè¨ªå•ï¼š["EditorActivity", "SettingsActivity"]
- ç•¶å‰é é¢ï¼šMainActivity
- ç•¶å‰ç•«é¢ï¼š
  {
    "page_name": "MainActivity",
    "children": [
      {
        "ID": 5,
        "widget_type": "Button",
        "resource_id": "add_note_button",
        "text": "New Note",
        "possible_action_types": ["touch"]
      },
      {
        "ID": 8,
        "widget_type": "ListView",
        "possible_action_types": ["scroll"]
      }
    ]
  }

Planner çš„è¼¸å‡ºï¼š
ä»»å‹™: Create a new note
ç¬¬ä¸€æ­¥å‹•ä½œ: touch_widget(target_widget_ID=5)

â†’ åˆ‡æ›åˆ° MODE_OBSERVE
â†’ å›å‚³å‹•ä½œçµ¦ä¸»ç¨‹å¼

[ä¸»ç¨‹å¼åŸ·è¡Œå‹•ä½œï¼šé»æ“Š ID 5 çš„æŒ‰éˆ•]
```

```
========== Step 2 ==========
Mode: MODE_OBSERVE

Observer çœ‹åˆ°çš„è®ŠåŒ–ï¼š
å‰ä¸€å€‹é é¢ï¼šMainActivity
ç•¶å‰é é¢ï¼šEditorActivity

æ–°å‡ºç¾çš„å…ƒä»¶ï¼š
- EditText (ID: 12) - æ¨™é¡Œè¼¸å…¥æ¡†
- EditText (ID: 13) - å…§å®¹è¼¸å…¥æ¡†
- Button (ID: 14) - å„²å­˜æŒ‰éˆ•

Observer çš„è¼¸å‡ºï¼š
"Opened the note editor page with title and content input fields"

â†’ è¨˜éŒ„åˆ° WorkingMemory
â†’ è¨˜éŒ„åˆ° SpatialMemory:
  {
    "page": "MainActivity",
    "widget": "Button-add_note_button-New Note",
    "action": "touch",
    "observation": "Opened the note editor page"
  }
â†’ åˆ‡æ›åˆ° MODE_ACT
```

```
========== Step 3 ==========
Mode: MODE_ACT

Actor çœ‹åˆ°çš„è³‡è¨Šï¼š
- ç•¶å‰ä»»å‹™ï¼šCreate a new note
- åŸ·è¡Œæ­·å²ï¼š
  1. [ACTION] é»æ“Š New Note æŒ‰éˆ•
  2. [OBSERVATION] é–‹å•Ÿç­†è¨˜ç·¨è¼¯é é¢
- ç•¶å‰é é¢ï¼šEditorActivity
- ç•¶å‰ç•«é¢ï¼š
  {
    "ID": 12,
    "widget_type": "EditText",
    "resource_id": "title_input",
    "possible_action_types": ["set_text"]
  }

Actor çš„è¼¸å‡ºï¼š
fill_text(target_widget_ID=12, text="My First Note")

â†’ åˆ‡æ›åˆ° MODE_OBSERVE
â†’ å›å‚³å‹•ä½œçµ¦ä¸»ç¨‹å¼
```

#### Step 4-8ï¼šç¹¼çºŒåŸ·è¡Œä»»å‹™

```
Step 4 (OBSERVE): è§€å¯Ÿåˆ°æ¨™é¡Œæ¬„ä½é¡¯ç¤ºæ–‡å­—
Step 5 (ACT): åœ¨å…§å®¹æ¬„ä½è¼¸å…¥æ–‡å­—
Step 6 (OBSERVE): è§€å¯Ÿåˆ°å…§å®¹æ¬„ä½é¡¯ç¤ºæ–‡å­—
Step 7 (ACT): é»æ“Šå„²å­˜æŒ‰éˆ•
Step 8 (OBSERVE): è§€å¯Ÿåˆ°å›åˆ° MainActivityï¼Œæ–°ç­†è¨˜å‡ºç¾åœ¨åˆ—è¡¨ä¸­
```

#### Step 9ï¼šåæ€ä»»å‹™

```
========== Step 9 ==========
Mode: MODE_ACT

Actor åˆ¤æ–·ä»»å‹™å·²å®Œæˆï¼Œé¸æ“‡ã€ŒçµæŸä»»å‹™ã€

â†’ åˆ‡æ›åˆ° MODE_REFLECT
```

```
========== Step 10 ==========
Mode: MODE_REFLECT

Reflector çœ‹åˆ°çš„è³‡è¨Šï¼š
- ä»»å‹™ï¼šCreate a new note
- ä»»å‹™å®Œæˆæ¢ä»¶ï¼šThe task is completed when a new note appears in the note list
- åŸ·è¡Œæ­·å²ï¼š
  1. é»æ“Š New Note æŒ‰éˆ•
  2. è§€å¯Ÿåˆ°é–‹å•Ÿç·¨è¼¯é é¢
  3. åœ¨æ¨™é¡Œæ¬„ä½è¼¸å…¥ "My First Note"
  4. è§€å¯Ÿåˆ°æ¨™é¡Œé¡¯ç¤º
  5. åœ¨å…§å®¹æ¬„ä½è¼¸å…¥å…§å®¹
  6. è§€å¯Ÿåˆ°å…§å®¹é¡¯ç¤º
  7. é»æ“Šå„²å­˜æŒ‰éˆ•
  8. è§€å¯Ÿåˆ°å›åˆ°ä¸»é é¢ï¼Œæ–°ç­†è¨˜å‡ºç¾
- ç•¶å‰é é¢ï¼šMainActivityï¼ˆæœ‰æ–°ç­†è¨˜ï¼‰

Reflector çš„è¼¸å‡ºï¼š
è©•ä¼°: æˆåŠŸ
çµæœæ‘˜è¦: Successfully created a new note titled "My First Note"
åæ€:
  - To create a note in this app, click "New Note", fill in title and content, then click save
  - The save button must be clicked to persist the note

â†’ è¨˜éŒ„åˆ° TaskMemory (ChromaDB)
â†’ åˆ‡æ›åˆ° MODE_PLAN
```

#### Step 11ï¼šè¦åŠƒç¬¬äºŒå€‹ä»»å‹™

```
========== Step 11 ==========
Mode: MODE_PLAN

Planner çœ‹åˆ°çš„è³‡è¨Šï¼š
- å·²è¨ªå•é é¢ï¼š{"MainActivity": 2, "EditorActivity": 1}
- æœªè¨ªå•ï¼š["SettingsActivity"]
- éå»ä»»å‹™ï¼š
  1. âœ“ Create a new noteï¼ˆæˆåŠŸï¼‰
- éå»åæ€ï¼š
  - To create a note, click "New Note", fill in fields, then save

Planner çš„è¼¸å‡ºï¼š
ä»»å‹™: Open the settings page to explore configuration options
ç¬¬ä¸€æ­¥å‹•ä½œ: touch_widget(target_widget_ID=3)  â† è¨­å®šæŒ‰éˆ•

â†’ ç¹¼çºŒå¾ªç’°...
```

---

## ç¸½çµ

### ç³»çµ±çš„æ ¸å¿ƒæ©Ÿåˆ¶

1. **éœæ…‹åˆ†æ APK** â†’ çŸ¥é“æœ‰å“ªäº›é é¢
2. **Accessibility Service** â†’ å³æ™‚çœ‹åˆ°ç•«é¢å…ƒä»¶
3. **æ™ºèƒ½è½‰æ›** â†’ å…ƒä»¶è½‰ Widgetï¼Œè‡ªå‹•åˆ¤æ–·å¯åŸ·è¡Œæ“ä½œ
4. **ç‹€æ…‹æ©Ÿæ§åˆ¶** â†’ PLAN â†’ OBSERVE â†’ ACT â†’ REFLECT å¾ªç’°
5. **ChromaDB è¨˜æ†¶** â†’ è¨˜ä½ Widget åŠŸèƒ½ï¼Œç´¯ç©æ¸¬è©¦çŸ¥è­˜

### èˆ‡å‚³çµ±æ¸¬è©¦å·¥å…·çš„å·®ç•°

| å‚³çµ±å·¥å…· | DroidAgent |
|---------|-----------|
| éš¨æ©Ÿé»æ“Š | æœ‰ç›®çš„çš„ä»»å‹™è¦åŠƒ |
| ä¸è¨˜å¾—æ“ä½œéä»€éº¼ | è¨˜ä½æ¯å€‹æŒ‰éˆ•çš„åŠŸèƒ½ |
| é‡è¤‡é»åŒæ¨£çš„æ±è¥¿ | çŸ¥è­˜ç´¯ç©ï¼Œé¿å…é‡è¤‡ |
| çœ‹ä¸æ‡‚ UI | ç†è§£ã€Œé€™æ˜¯ç™»å…¥æŒ‰éˆ•ã€ |
| ç„¡æ³•å­¸ç¿’ | åæ€æ©Ÿåˆ¶ï¼Œç´¯ç©ç¶“é©— |

---

**æ–‡ä»¶ç”Ÿæˆæ™‚é–“**ï¼š2025-01-15
**ä½œè€…**ï¼šClaude (Anthropic)
**å°ˆæ¡ˆ**ï¼šDroidAgent - Intent-Driven Android GUI Testing Framework
